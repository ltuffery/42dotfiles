#!/usr/bin/env bash

# ##############################################################################
# ## config                                                                    #
# ##############################################################################

FTDOTDIR="${HOME}/.local/share/42dotfiles";

# ##############################################################################
# ## utils                                                                     #
# ##############################################################################

utils_addpath()
{
	if [ -d ${1} ]; then
		export PATH="${1}:${PATH}";
	fi
}

utils_git()
{
	git -C "${FTDOTDIR}" ${@};
}

utils_isbehind()
{
	LOCAL="master";
	REMOTE="origin/master";

	LOCAL_COMMIT="$(utils_git rev-parse ${LOCAL})";
	REMOTE_COMMIT="$(utils_git rev-parse ${REMOTE})";
	MERGE_BASE_COMMIT="$(utils_git merge-base ${LOCAL} ${REMOTE})";

	if [ "${REMOTE_COMMIT}" = "${LOCAL_COMMIT}" ]; then
		return 1; #local repo is up-to-date
	fi
	if [ "${REMOTE_COMMIT}" = "${MERGE_BASE_COMMIT}" ]; then
		return 1; #local repo is ahead of origin
	fi
	return 0;
}

utils_chezmoi()
{
	chezmoi --source "${FTDOTDIR}" ${@};
}

# ##############################################################################
# ## commands                                                                  #
# ##############################################################################

cmd_fetch()
{
	if [ "$(utils_git branch --show-current)" != "master" ]; then
		echo "error: 42df HEAD doesn't point to master" >&2;
		exit 1;
	fi
	utils_git fetch origin master:refs/remotes/origin/master > /dev/null;
	if utils_isbehind; then
		echo "update available, update with 42df update";
	else
		echo "42df is up-to-date";
	fi
}

cmd_update()
{
	cmd_fetch > /dev/null;
	if utils_isbehind; then
		utils_chezmoi update --init;
	else
		echo "42df is up-to-date";
	fi
}

cmd_config()
{
	utils_chezmoi init --apply;
	echo "done, consider restarting shell";
}

cmd_startup()
{
	if [ -z "${FTDF_ENV}" ]; then
		export FTDF_ENV=1;
		fish;
	else
		echo "42df already running";
	fi
}

# ##############################################################################
# ## Main                                                                      #
# ##############################################################################

main()
{
	utils_addpath "${FTDOTDIR}/bin";
	utils_addpath "${FTDOTDIR}/scripts";

	case "${@}" in
		"fetch") cmd_fetch;;
		"update") cmd_update;;
		"config") cmd_config;;
		"startup") cmd_startup;;
		*) echo "bad input";;
	esac
}

main ${@};
